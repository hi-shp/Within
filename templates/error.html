{% extends 'base.html' %}

{% block title %}지목 오류 - Withinstar{% endblock %}

{% block content %}
<div class="main-content">
    <div class="error-container">
        <div class="error-box">
            <h1 class="error-title" style="color: #d9534f;" 
                data-lang-eng="Error occurred! Matching failed." 
                data-lang-kor="오류 발생! 매칭이 실패했습니다.">
                오류 발생! 매칭이 실패했습니다.
            </h1>
            <p class="error-message" style="color: #d9534f;" 
               data-lang-eng="Only one person can be selected. If you want to select additional people, please proceed with payment." 
               data-lang-kor="한 명만 지목 가능합니다. 추가 지목을 원하시면 결제를 진행해주세요.">
                한 명만 지목 가능합니다. 추가 지목을 원하시면 결제를 진행해주세요.
            </p>
            <p class="error-info" style="color: #333;" 
               data-lang-eng="❤️ 'Would you like to express additional interest?'<br>If you express additional interest, a fee of <strong style='color: #d9534f;'>2,500 KRW per attempt</strong> will be charged.<br>Share your feelings secretly with <strong>Withinstar</strong>!"
               data-lang-kor="❤️ '추가 지목을 원하시나요?'<br>이후 추가로 관심을 표현하실 경우, <strong style='color: #d9534f;'>1회당 2,500원</strong>의 요금이 부과됩니다.<br>비밀스럽게 마음을 전하는 <strong>Withinstar</strong>와 함께하세요!">
                ❤️ '추가 지목을 원하시나요?'<br>
                이후 추가로 관심을 표현하실 경우, <strong style="color: #d9534f;">1회당 2,500원</strong>의 요금이 부과됩니다.<br>
                비밀스럽게 마음을 전하는 <strong>Withinstar</strong>와 함께하세요!
            </p>
            <button class="error-button" id="openPopup" style="background-color: #d9534f;" 
                onclick="gtag('event', 'pay_2500_oferror');" 
                data-lang-eng="Express Feelings" 
                data-lang-kor="마음 전달하기">
                마음 전달하기
            </button>
            <hr class="divider" style="border: 1px solid #f5c6cb; margin: 10px 0;">
            <p style="color: #555;" 
               data-lang-eng="Alternatively, you can delete the existing registration and select a new person." 
               data-lang-kor="혹은, 기존의 등록을 삭제하고 새로운 사람을 선택할 수 있습니다.">
                혹은, 기존의 등록을 삭제하고 새로운 사람을 선택할 수 있습니다.
            </p>
            <input type="hidden" id="encryptedID" value="{{ encrypted_id }}">
            <button id="changeTargetButton" style="background-color: #5bc0de;" 
                onclick="gtag('event', 'exchange_id');" 
                data-lang-eng="Change Registered Target" 
                data-lang-kor="등록한 상대 바꾸기">
                등록한 상대 바꾸기
            </button>
            <hr class="divider" style="border: 1px solid #f5c6cb; margin: 10px 0;">
            <h2 class="features-title" style="color: #333;" 
                data-lang-eng="Service Features" 
                data-lang-kor="서비스 특징">
                서비스 특징
            </h2>
            <ul class="features-list" style="list-style: none; padding: 0; color: #555; font-size: 0.8rem; line-height: 1.8; margin-bottom: 20px;">
                <li data-lang-eng="🔒 Your information will never be disclosed thanks to our encryption system."
                    data-lang-kor="🔒 암호화 시스템으로 정보가 절대 공개되지 않습니다.">
                    🔒 암호화 시스템으로 정보가 절대 공개되지 않습니다.
                </li>
                <li data-lang-eng="📩 Receive an instant notification via Instagram DM when matched!"
                    data-lang-kor="📩 상대방과 매칭 성공 시 Instagram DM으로 바로 알림!">
                    📩 상대방과 매칭 성공 시 Instagram DM으로 바로 알림!
                </li>
                <li data-lang-eng="💌 Experience a simple and intuitive way to express your feelings."
                    data-lang-kor="💌 마음을 전하는 간단하고 직관적인 서비스를 경험하세요.">
                    💌 마음을 전하는 간단하고 직관적인 서비스를 경험하세요.
                </li>
            </ul>
            <div style="text-align: center;">
                <a href="/" class="home-link" style="color: #d9534f; text-decoration: none; font-size: 0.8rem; padding-top: 20px; display: inline-block;"
                   data-lang-eng="Go back to Home" 
                   data-lang-kor="홈으로 돌아가기">
                    홈으로 돌아가기
                </a>
            </div>
        </div>
    </div>
</div>

<div id="popup" class="popup" style="display: none;">
    <div class="popup-content">
        <h2 data-lang-eng="Feature Under Development" 
            data-lang-kor="기능 준비 중">
            기능 준비 중
        </h2>
        <p data-lang-eng="'Express Feelings' is under development.<br>However, free matching works properly.<br>Please wait! We'll deliver better services. 😊"
           data-lang-kor="'마음 전달하기' 기능은 현재 구현 중입니다.<br>하지만 무료 매칭은 정상적으로 작동합니다.<br>조금만 기다려 주세요! 더 나은 서비스를 제공하겠습니다. 😊">
            '마음 전달하기' 기능은 현재 구현 중입니다.<br>
            하지만 무료 매칭은 정상적으로 작동합니다.<br>
            조금만 기다려 주세요! 더 나은 서비스를 제공하겠습니다. 😊
        </p>
        <button id="closePopup" class="popup-button" 
            data-lang-eng="Close" 
            data-lang-kor="닫기">
            닫기
        </button>
    </div>
</div>

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
    const openPopupButton = document.getElementById("openPopup");
    const popup = document.getElementById("popup");
    const closePopupButton = document.getElementById("closePopup");
    const changeTargetButton = document.getElementById("changeTargetButton");

    // 팝업 열기
    if (openPopupButton) {
        openPopupButton.addEventListener("click", function () {
            popup.style.display = "flex"; // 팝업 표시
        });
    }

    // 팝업 닫기
    if (closePopupButton) {
        closePopupButton.addEventListener("click", function () {
            popup.style.display = "none"; // 팝업 숨김
        });
    }

    // 기존 대상 변경 요청
    if (changeTargetButton) {
        const handleChangeTarget = async () => {
            if (changeTargetButton.disabled) return; // 이미 처리 중이라면 요청 중복 방지
            changeTargetButton.disabled = true; // 버튼 비활성화

            const encryptedID = document.getElementById("encryptedID").value;
            console.log("삭제 요청 전송 시작"); // 디버깅 로그

            try {
                const response = await fetch('/delete_target', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ encryptedID }),
                });

                const result = await response.json();
                console.log("응답 수신:", result); // 디버깅 로그

                if (result.message) {
                    alert(result.message);
                    window.location.href = '/'; // 홈으로 리다이렉트
                } else if (result.error) {
                    alert(result.error);
                }
            } catch (error) {
                console.error("오류 발생:", error); // 디버깅 로그
                alert('삭제 요청 중 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                changeTargetButton.disabled = false; // 버튼 활성화
            }
        };

        // 기존 이벤트 핸들러 제거 후 등록
        changeTargetButton.removeEventListener("click", handleChangeTarget);
        changeTargetButton.addEventListener("click", handleChangeTarget);
    }
});
</script>
{% endblock %}
{% endblock %}